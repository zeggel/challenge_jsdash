The idea is build tree of possible paths and select best one.
Solution has several optimizations to build tree with more branches.
Sorry for the code, it's draft. I was going to write clean human readable version but have no time.
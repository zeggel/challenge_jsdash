"use strict";const t=0,e=1,i=2,l=3;const s={t:t,r:e,d:i,i:l};const r={0:"u",1:"r",2:"d",3:"l",undefined:"."};function f(t){return(t+1)%4}function n(t){return(t+3)%4}function h(t){return t==="*"||t==="O"}function u(t){return t===" "||t===":"||t==="*"||t==="!"}function o(t){return t==="/"||t==="|"||t==="\\"||t==="-"}function c(t){return t==="+"||t==="O"||t==="*"}function a(t){return!(t==="+"||t==="O"||t==="#")}function w(t){return t===" "||t==="A"||t==="/"||t==="|"||t==="\\"||t==="-"||t==="!"}function d(t){return t===":"||t==="*"}function p(t,e){return t+(e<<8)}function b(s,r){if(r.x==s.x-1)return l;if(r.x==s.x+1)return e;if(r.y==s.y-1)return t;if(r.y==s.y+1)return i}function k(t){return e=>t.indexOf(e)!=-1}class _{constructor(t,e){this.x=t;this.y=e}l(){return new _(this.x,this.y-1)}right(){return new _(this.x+1,this.y)}s(){return new _(this.x,this.y+1)}left(){return new _(this.x-1,this.y)}step(s){switch(s){case t:return this.l();case e:return this.right();case i:return this.s();case l:return this.left();default:return this}}h(t){return this.x==t.x&&this.y==t.y}key(){return p(this.x,this.y)}}class y{constructor(t){this.u=t;this.o=undefined;this.mark=t.frame}p(t){this.o=t}move(t){if(this.o)this.u.set(this.o);if(t)this.u.set(t,this)}update(){this.mark=this.u.frame}k(){}_(){return false}O(){return false}A(){return true}g(){}m(t){return false}$(t){}}class O extends y{constructor(t){super(t);this.mark=1e99}k(){return"#"}$(t){return this}}class A extends y{constructor(t){super(t);this.mark=1e99}k(){return"+"}_(){return true}O(){return true}$(t){let e=new A(t);e.o=this.o;e.mark=this.mark;return e}}class g extends y{constructor(t){super(t);this.mark=1e99}k(){return":"}O(){return true}m(t){return true}$(t){let e=new g(t);e.o=this.o;e.mark=this.mark;return e}}class x{constructor(t){this.u=t;this.map={}}get(t){let e=this.map[t.key()];if(e===undefined){return this.u.get(t)}return e}set(t,e){if(e===undefined){e=null}this.map[t.key()]=e}}class m extends y{constructor(t){super(t);this.M=false}update(){super.update();let t=this.o.s();let e=this.u.get(t);if(e&&e._()){if(this.S(this.o.left())||this.S(this.o.right()))return}if(e&&this.M){e.g();this.M=false}else if(!e){if(!this.M)this.u.D.push(this);this.M=true;this.move(t)}if(this.M)this.u.M.push(this)}v(t){let e=this.o.s();let i=t.get(e);if(i&&i._()){let e=this.o.left();let i=t.get(e);if(!i||i.k()=="A"){let i=t.get(e.s());if(!i||i.k()=="A"){let i=new this.constructor(this.u);i.o=e;i.M=true;t.set(this.o);t.set(i.o,i);return i}}let l=this.o.right();let s=t.get(l);if(!s||s.k()=="A"){let e=t.get(l.s());if(!e||e.k()=="A"){let e=new this.constructor(this.u);e.o=l;e.M=true;t.set(this.o);t.set(e.o,e);return e}}}let l=this.o;let s=this.M;if(i&&this.M&&!w(i.k())){s=false}else if(!i||i.k()=="A"){s=true;l=e}let r=new this.constructor(this.u);r.o=l;r.M=s;if(!this.o.h(r.o)){t.set(this.o);t.set(r.o,r)}return r}S(t){if(this.u.get(t)||this.u.get(t.s()))return false;if(!this.M)this.u.D.push(this);this.M=true;this.move(t);this.u.M.push(this);return true}_(){return!this.M}O(){return true}A(){return!this.M}}class $ extends m{k(){return"O"}m(e){if(this.M||e==t||e==i)return false;let l=this.o.step(e);if(!this.u.get(l)){this.move(l);return true}return false}$(t){let e=new $(t);e.o=this.o;e.mark=this.mark;e.M=this.M;return e}}class M extends m{k(){return"*"}m(t){this.u.q();return true}$(t){let e=new M(t);e.o=this.o;e.mark=this.mark;e.M=this.M;return e}}class S extends y{constructor(t){super(t);this.B=0}k(){return"!"}update(){if(++this.B>3)this.u.set(this.o,new M(this.u))}A(){return false}$(t){let e=new S(t);e.o=this.o;e.mark=this.mark;e.B=this.B;return e}}class D extends y{constructor(e){super(e);this.name="";this.dir=t;this.U=true}k(){return"/|\\-"[this.u.frame%4]}v(t){let e=new Array(4);for(let t=0;t<4;t++)e[t]=this.o.step(t);let i=e.map(e=>t.get(e));let l=this.o;let s=this.dir;let r=n(this.dir);if(!i[r]||i[r].k()=="A"){l=e[r];s=r}else if(!i[s]||i[s].k()=="A"){l=e[s]}else{s=f(s)}let h=new D(this.u);h.name=this.name;h.o=l;h.dir=s;if(!this.o.h(l)){t.set(this.o);t.set(l,h)}return h}update(){super.update();let t=new Array(4);for(let e=0;e<4;e++)t[e]=this.o.step(e);let e=t.map(t=>this.u.get(t));let i=true;for(let t of e){if(!t)i=false;else if(t===this.u.C)return this.H()}if(i)return this.H();this.u.I.push(this);let l=n(this.dir);if(!e[l]){this.move(t[l]);this.dir=l}else if(!e[this.dir])this.move(t[this.dir]);else this.dir=f(this.dir)}O(){return true}g(){if(this.U)this.H()}H(){this.U=false;let t=this.o.x-1,e=this.o.x+1;let i=this.o.y-1,l=this.o.y+1;let s=false;for(let r=i;r<=l;r++){for(let i=t;i<=e;i++){let t=new _(i,r);let e=this.u.get(t);if(e){if(!e.O())continue;if(e!==this)e.g();if(e===this.u.C)s=true}this.u.set(t,new S(this.u))}}if(!s)this.u.X=true;this.u.j()}$(t){let e=new D(t);e.name=this.name;e.o=this.o;e.mark=this.mark;e.dir=this.dir;e.U=this.U;return e}}class v extends y{constructor(t){super(t);this.U=true;this.F=false;this.control=undefined}k(){return this.U?"A":"X"}update(){super.update();if(!this.U||this.control===undefined)return;let t=this.o.step(this.control);let e=this.u.get(t);if(!e||e.m(this.control))this.move(t);this.control=undefined}O(){return true}g(){this.U=false}$(t){let e=new v(t);e.o=this.o;e.mark=this.mark;e.U=this.U;e.F=this.F;e.control=this.control;return e}}function q(t){return t?t.k():" "}function B(t){return!!t.o}class U{constructor(t){this.number=0;let e=this.width=40;let i=this.height=22;this.frame=0;this.G=1200;this.J=0;this.K=0;this.L=0;this.N=0;this.P=0;this.X=false;this.D=[];this.M=[];this.I=[];this.C=new v(this);this.cells=new Array(i);for(let t=0;t<i;t++)this.cells[t]=new Array(e);if(!t)return;let l=0;for(let s=0;s<i;s++){let i=t[s];for(let t=0;t<e;t++){let e=i[t];let r=new _(t,s);switch(e){case" ":break;case"#":this.set(r,new O(this));break;case"+":this.set(r,new A(this));break;case":":this.set(r,new g(this));break;case"O":this.set(r,new $(this));break;case"*":this.set(r,new M(this));break;case"-":case"/":case"|":case"\\":let t=new D(this);t.name=["Adonis Blue","Black Hairstreak","Chequered Skipper"][l++];this.set(r,t);this.I.push(t);break;case"A":this.set(r,this.C);break}}}}get(t){return this.cells[t.y][t.x]}set(t,e){let i=this.cells[t.y][t.x];if(i===e)return;this.cells[t.y][t.x]=e;if(i)i.p();if(e)e.p(t)}q(){this.J++;this.N++;this.K++;this.L=20;this.R=8;if(this.K<3)return;for(let t=2;t*t<=this.K;t++){if(this.K%t===0)return}this.J+=this.K}j(){if(!this.C.U)return;this.P++;this.J+=10;this.R=8}update(){this.frame++;if(this.G)this.G--;if(this.K&&!--this.L){this.K=0}if(this.R)this.R--;this.X=false;this.D=[];this.M=[];this.I=[];let t=this.width-1;let e=this.height-1;for(let i=1;i<e;i++){for(let e=1;e<t;e++){let t=this.cells[i][e];if(t){if(t.mark<this.frame)t.update()}}}this.D=this.D.filter(B);this.M=this.M.filter(B);this.I=this.I.filter(B)}control(t){this.C.control=t}map(){let t=new Array(this.height);for(let e=0;e<this.height;e++){let i="";for(let t=0;t<this.width;t++){let l=this.cells[e][t];i+=q(l)}t[e]=i}return t}T(){let s=this.C;let r=s.o;if(!r)return[];let f=r.x;let n=r.y;let c=this.cells[n][f-1];let w=this.cells[n][f+1];let d=this.cells[n-1][f];let p=this.cells[n+1][f];let b=this.cells[n-1][f-1];let k=this.cells[n-1][f+1];let _=this.cells[n+1][f-1];let y=this.cells[n+1][f+1];let O=q(c);let A=q(w);let g=q(d);let x=q(p);let m=q(b);let $=q(k);let M=q(_);let S=q(y);let D=[];if(u(O)||O==="O"){let e=true;if(O=="O"){if(c.M){if(_&&(!_._()||this.cells[n][f-2]||this.cells[n+1][f-2]))e=false}else{if(this.cells[n][f-2])e=false}}if(o(m))e=false;let i=this.cells[n][f-2];if(o(x)&&p.dir==t&&_)if(!a(q(this.cells[n-1][f-2]))&&!a(q(i))&&!a(q(this.cells[n+1][f-2])))e=false;if(o(q(i)))e=false;if(m=="O"&&O===" ")e=false;if(m==" "&&h(q(this.cells[n-2][f-1])))e=false;if(e)D.push(l)}if(u(A)||A==="O"&&!w.M&&!this.cells[n][f+2]){let i=true;if(o($))i=false;if($=="O"&&A===" ")i=false;if(o(x)&&p.dir==t&&_)i=false;if($==" "&&h(q(this.cells[n-2][f+1])))i=false;if(i)D.push(e)}if(u(g)){let e=true;if(g==" "&&q(this.cells[n-2][f])=="O")e=false;if(e)D.push(t)}if(u(x)){let t=true;if(o(M))t=false;if(o(A)&&w.dir==l&&y)t=false;if(t)D.push(i)}let v=true;if(g==" "&&q(this.cells[n-2][f])=="O")v=false;if(o(A)||o(x))v=false;if(v)D.push(undefined);return D}V(t){let e=this.$();e.control(t);e.update();let i=e.C;if(i.U&&i.o){i.U=e.W();i.F=e.Y()}return e}W(){if(!this.C.U)return false;let t=this.C.o.x;let e=this.C.o.y;let i=this.cells[e][t-1];let l=this.cells[e][t+1];let s=this.cells[e-1][t];let r=this.cells[e+1][t];let f=this.cells[e-1][t-1];let n=this.cells[e-1][t+1];let u=this.cells[e+1][t-1];let c=this.cells[e+1][t+1];let a=q(i);let w=q(l);let d=q(s);let p=q(r);let b=q(f);let k=q(n);let _=q(u);let y=q(c);if(o(b)){let i=this.cells[e-2][t-1];if(i&&i.M)return false}if(o(k)){let i=this.cells[e-2][t+1];if(i&&i.M)return false}if(o(_)){let i=this.cells[e][t-1];if(i&&i.M)return false}if(o(y)){let i=this.cells[e][t+1];if(i&&i.M)return false}if(o(w)){let i=this.cells[e-1][t+1];if(i&&i.M)return false}if(o(a)||o(d))return false;if(h(d)&&s.M)return false;return true}Y(){let t=this.C.o.x;let e=this.C.o.y;let i=this.cells[e][t-1];let l=this.cells[e][t+1];let s=this.cells[e-1][t];let r=this.cells[e+1][t];let f=this.cells[e-1][t-1];let n=this.cells[e-1][t+1];let h=this.cells[e+1][t-1];let o=this.cells[e+1][t+1];let a=q(i);let p=q(l);let b=q(s);let k=q(r);let _=q(f);let y=q(n);let O=q(h);let A=q(o);let g=u(a)||u(p)||u(b)||u(k)||a==="O"&&(w(q(this.cells[e][t-2]))||i.M&&O==" "||this.cells[e][t-2]&&this.cells[e][t-2].M&&w(q(this.cells[e+1][t-2])))||p==="O"&&(w(q(this.cells[e][t+2]))||l.M&&A==" "||this.cells[e][t+2]&&this.cells[e][t+2].M&&w(q(this.cells[e+1][t+2])));if(!g)return true;const x=20;let m=new Set;let $=[this.C.o];let M=[];while($.length&&m.size<=x){let t=$.pop();m.add(t.key());for(let e=0;e<4;e++){let i=t.step(e);let l=i.key();let s=this.get(i);let r=q(s);if(u(r)||w(r)){if(!m.has(l)){m.add(l);$.push(i)}}else if(r=="O")M.push(s)}}if(m.size<=x){t:for(let t of M){let e=t.o.left();let i=e.key();let l=t.o.right();let s=l.key();let r;if(m.has(i)&&!m.has(s))r=l;else if(!m.has(i)&&m.has(s))r=e;if(r&&w(q(this.get(r)))){$.push(t.o);m.add(t.o.key());continue}let f=t.o.s();let n=f.key();let h=q(this.get(f));while(m.has(n)&&(d(h)||w(h))){if(m.has(i)||m.has(s)||m.has(t.o.l().key())){$.push(t.o);m.add(t.o.key());continue t}f=f.s();n=f.key();h=q(this.get(f));i=f.left().key();s=f.right().key()}if(c(h)){let r=q(this.get(l));let f=q(this.get(e));let n=l.s();let h=q(this.get(n));let u=n.key();let o=e.s();let c=q(this.get(o));let a=o.key();if(m.has(s)&&m.has(u)&&(d(r)||w(r))&&(d(h)||w(h))){$.push(t.o);m.add(t.o.key());continue}if(m.has(i)&&m.has(a)&&(d(f)||w(f))&&(d(c)||w(c))){$.push(t.o);m.add(t.o.key());continue}}}while($.length&&m.size<=x){let t=$.pop();m.add(t.key());for(let e=0;e<4;e++){let i=t.step(e);let l=i.key();let s=this.get(i);let r=q(s);if(u(r)){if(!m.has(l)){m.add(l);$.push(i)}}}}if(m.size<=x)return true}return false}Z(t){if(!this.C.U)return;let e=this.T();while(t--&&e.length==1){this.control(e[0]);this.update();if(!this.C.U||this.C.F)return;e=this.T()}if(!e.length)this.C.U=false;else if(!this.W())this.C.U=false;else if(this.Y())this.C.F=true}tt(){if(!this.C.U)return false;if(this.X)return true;return this.et()}et(){if(!this.M.length||!this.I.length||!this.C.U)return false;let t=this.C.o;let e=[...this.M,...this.I];let i=new x(this);for(let l=0;l<19;l++){let l=[];e.sort(L);for(let t of e){t=t.v(i);l.push(t)}for(let e of l){if(e instanceof D){let l=i.get(e.o.l());if(l&&l.M){if(e.o.y-t.y<2&&t.x>=e.o.x-1&&t.x<=e.o.x+1&&!a(q(this.get(t.l())))){return false}return true}}}e=l}}it(t){let e=[...this.M,...this.I];t.set(this.C.o);let i=new Map;let l=new Map;for(let s=0;s<50;s++){for(let t of e){if(t instanceof D){let e=`${t.name}-${t.o.x},${t.o.y}-${t.dir}`;if(i.has(e)){if(!l.has(t.name))l.set(t.name,s-i.get(e))}else{i.set(e,s)}}}e.sort(L);for(let i=0;i<e.length;i++){e[i]=e[i].v(t)}}for(let t of this.I){if(!l.has(t.name))l.set(t.name,Infinity)}return l}$(){let t=new U;let e=t.width=this.width;let i=t.height=this.height;t.number=this.number+1;t.frame=this.frame;t.G=this.G;t.J=this.J;t.K=this.K;t.L=this.L;t.N=this.N;t.P=this.P;for(let l=0;l<i;l++){for(let i=0;i<e;i++){let e=this.cells[l][i];if(e){let s=e.$(t);t.cells[l][i]=s;if(e===this.C)t.C=s}}}return t}}function C(t,e){if(t<e)return t;return e}function H(t,e){if(t>e)return t;return e}function I(t,e,i){let l=[];let s=H(0,e.x-i);let r=0;let f=C(t[0].length-1,e.x+i);let n=e.y-1;let u=[];for(let e=s;e<=f;e++){for(let i=r;i<=n;i++){let l=t[i][e];if(!d(l))continue;if(h(t[i-1][e]))continue;if(h(t[i-1][e-1])&&c(t[i][e-1])&&w(t[i-1][e])||h(t[i-1][e+1])&&c(t[i][e+1])&&w(t[i-1][e])||h(t[i][e-1])&&c(t[i+1][e-1])&&w(t[i+1][e])||h(t[i][e+1])&&c(t[i+1][e+1])&&w(t[i+1][e]))continue;u.push(new _(e,i))}}return u}function X(t,e,i){let l={o:new _(e.x,e.y)};let s=[l];let r=[];let f=H(0,e.x-i);let n=H(0,e.y-i);let u=C(t[0].length-1,e.x+i);let o=C(t.length-2,e.y+i);for(let e=f;e<=u;e++){for(let i=n;i<=o;i++){let l=t[i][e];if(w(l)&&(t[i][e-1]=="O"&&w(t[i][e-2])||t[i][e+1]=="O"&&w(t[i][e+2]))){r.push(new _(e,i));continue}if(!d(l))continue;if(h(t[i-1][e])||h(t[i-1][e-1])&&c(t[i][e-1])&&w(t[i-1][e])||h(t[i-1][e+1])&&c(t[i][e+1])&&w(t[i-1][e])||h(t[i][e-1])&&c(t[i+1][e-1])&&w(t[i+1][e])||h(t[i][e+1])&&c(t[i+1][e+1])&&w(t[i+1][e])||h(t[i][e-1])&&w(t[i][e-2])&&w(t[i+1][e-2])||h(t[i][e+1])&&w(t[i][e+2])&&w(t[i+1][e+2])){r.push(new _(e,i))}}}return r}class j{constructor(){this.lt=[]}push(t,e){let i=this.lt.length;this.lt.push({st:t,c:e});while(i>0){let t=i-1>>1;let l=this.lt[t];if(l.c<e)break;this.lt[t]=this.lt[i];this.lt[i]=l;i=t}}pop(){let t=this.lt[0].st;let e=this.lt.length-1;this.lt[0]=this.lt[e];this.lt.length--;let i=0;while(i>=0){let t=-1;let l=(i<<1)+1;let s=l+1;if(s<e&&this.lt[s].c<this.lt[i].c){if(this.lt[l].c<this.lt[s].c)t=l;else t=s}else{if(l<e&&this.lt[l].c<this.lt[i].c)t=l}if(t>=0){let e=this.lt[i];this.lt[i]=this.lt[t];this.lt[t]=e}i=t}return t}empty(){return!this.lt.length}}function z(t,e,i){let l=i.x;let s=i.y;if(o(t[s][l]))return 10;let r=1;if(i.x==1||i.x==38)r+=2;if(i.y==1||i.y==20)r+=2;for(let e=s-1;e<=s+1;e++)for(let i=l-1;i<=l+1;i++)if(o(t[e][i]))r+=3;let f=t[s][l];if(f=="*")r+=2;else if(f=="O"){let i=l-e.x;if(w(t[s][l+i])&&w(t[s+1][l+i]))r+=1}else if(d(f)){let e=0;if(h(t[s-1][l]))e+=1;if(h(t[s][l-1])&&c(t[s+1][l-1])&&w(t[s+1][l]))e+=1;if(h(t[s][l+1])&&c(t[s+1][l+1])&&w(t[s+1][l]))e+=1;if(h(t[s-1][l+1])&&c(t[s][l+1])&&w(t[s-1][l]))e+=1;if(h(t[s-1][l-1])&&c(t[s][l-1])&&w(t[s-1][l]))e+=1;if(!e)e=-1;r+=e}return r}function E(t,e,i){if(t[i.y][i.x]==":")return 2;return 1}function F(e,l,s){let r=new Set;let f=[l];r.add(l.key());for(let l=0;l<s&&f.length;l++){let l=[];while(f.length){let s=f.pop();for(let f=0;f<4;f++){let n=s.step(f);let h=n.key();if(!r.has(h)){let s=q(e.cells[n.y][n.x]);if(s=="*")return true;if(s=="#"||s=="+")continue;if(s=="O"){if(f==t||f==i)continue;let l=n.step(f);if(!w(q(e.cells[l.y][l.x])))continue}r.add(h);l.push(n)}}}f=l}return false}function G(e,l,s,r,f,n){if(l.h(s))return[undefined];let h=new j;h.push(l,0);let u=new Map;u.set(l.key(),{rt:0,length:0});while(!h.empty()){let l=h.pop();for(let o=0;o<4;o++){let c=l.step(o);if(c.h(s)){let t=[];t.unshift(b(l,c));let e=u.get(l.key());while(e.from){t.unshift(b(e.from,l));l=e.from;e=u.get(l.key())}return t}if(tt(c,s)>r)continue;let a=e[c.y][c.x];if(a=="#"||a=="+")continue;if(a=="O"){if(o==t||o==i)continue;let l=c.step(o);if(!w(e[l.y][l.x]))continue}let d=u.get(l.key());let p=d.length+1;if(p>=r)continue;let k=d.rt+f(e,l,c);if(n)k+=n.get(l,c);let _=c.key();let y=u.get(_);if(!y||k<y.rt){u.set(_,{rt:k,from:l,length:p});h.push(c,k+tt(l,s))}}}return[]}function J(s,r,f,n){if(r.h(f))return[undefined];let h=new j;h.push(r,0);let u=new Map;u.set(r.key(),{length:0});let o=[t,e,i,l];while(!h.empty()){let t=h.pop();K(o);for(let e of o){let i=t.step(e);if(i.h(f)){let e=[];e.unshift(b(t,i));let l=u.get(t.key());while(l.from){e.unshift(b(l.from,t));t=l.from;l=u.get(t.key())}return e}if(tt(i,f)>n)continue;let l=s[i.y][i.x];if(!a(l))continue;let r=u.get(t.key());let o=r.length+1;if(o>=n)continue;let c=i.key();let w=u.get(c);if(!w){u.set(c,{from:t,length:o});h.push(i,o)}}}return[]}function K(t){for(var e=t.length-1;e>0;e--){var i=V(e+1);var l=t[e];t[e]=t[i];t[i]=l}return t}function L(t,e){if(!t.o)return-1;if(!e.o)return 1;let i=t.o.y-e.o.y;if(i)return i;return t.o.x-e.o.x}function N(t,e){let i="";while(t!==e){i=(t.d?r[t.d]:".")+i;t=t.st}return i}function P(t){return function(e,i){let l=t.get(e);let s=t.get(i);let r=l.length-s.length;if(r)return r;return l<s?-1:1}}class Q{constructor(){this.map=new Map}add(t,e){let i=this.map.get(t);if(i===undefined||i.length>e.length)this.map.set(t,e)}ft(){let t=[...this.map.keys()];let e=P(this.map);t.sort(e);return t}}function R(t){return e=>e!==t}let T=1;function V(t){const e=1103515245;const i=12345;const l=2147483647;T=(e*T+i)%l;return T%t}function W(s,f,n,h){let u=[t,e,i,l,undefined];let o=new Set;let c=new Set;let a=new Map;let w=new Q;t:for(let t of s.T()){let e=r[t];let i=s.V(t);a.set(e,i);if(!i.C.U||i.C.F){o.add(t);continue}if(i.tt()){w.add(t,e)}for(let l=0;l<C(4,i.G);l++){let l=i.T().filter(R(t));if(!l.length)continue t;let s=l[V(l.length)];e+=r[s];i=i.V(s);a.set(e,i);if(!i.C.U||i.C.F)continue t;if(i.tt()){w.add(t,e)}}i.Z(6);if(!i.C.U||i.C.F)continue t;c.add(t)}if(s.I.length){let t=s.C.o;let e=X(f,t,6);t:for(let i of e){if(Date.now()-n>=50){break t}let e=tt(i,t);let l=G(f,t,i,e+4,z);if(!l.length){l=J(f,t,i,e+4);if(!l.length)continue}let h="";let u=s;for(let t of l){if(!u.T().includes(t))continue t;h+=r[t];let e=a.get(h);let i=true;if(!e){e=u.V(t);i=false;a.set(h,e)}u=e;if(!u.C.U||u.C.F)continue t;if(!i&&u.tt()){w.add(l[0],h)}}if(l.length>=4){u.Z(6);if(u.C.U&&!u.C.F){c.add(l[0])}}for(let t of u.T()){let e=u.V(t);a.set(h+r[t],e);if(!e.C.U||e.C.F)continue t;if(e.tt()){w.add(l[0],h+r[t]);continue t}e=e.V();if(!e.C.U||e.C.F)continue t;if(e.tt()){w.add(l[0],h+r[t]);continue t}}u=a.get(h+".");if(u&&u.C.U&&!u.C.F){for(let t of u.T()){let e=u.V(t);a.set(h+r[t],e);if(!e.C.U||e.C.F)continue t;if(e.tt()){w.add(l[0],h+r[t]);break}e=e.V();if(!e.C.U||e.C.F)continue t;if(e.tt()){w.add(l[0],h+r[t]);break}}}}if(!w.map.size&&Date.now()-n<50){let t=[];for(let e of[...c]){let i=r[e];let l=a.get(i);if(!l)continue;t.push({label:i,w:l,nt:e})}for(let e=0;e<2;e++){let e=[];for(let i of t){t:for(let t of i.w.T()){let l=i.label+r[t];let s=a.get(l);let f=true;if(!s){if(Date.now()-n>=50){break t}s=i.w.V(t);f=false;a.set(l,s)}if(s.W()&&!s.Y()){if(!f&&s.tt())w.add(i.nt,l);e.push({label:l,w:s,nt:i.nt})}}}t=e}}}let d=u.filter(nt(c)).filter(nt(o));t:for(let t of d){let e=r[t];let i=a.get(e);if(!i)continue;i.Z(6);let l={label:e,w:i};let s=[l];for(let e=0;e<h;e++){let i=[];for(let l of s){e:for(let s of l.w.T()){let f=l.label+r[s];let u=a.get(f);let o=true;if(!u){if(Date.now()-n>=50){break t}u=l.w.V(s);o=false;a.set(f,u)}if(u.C.U&&!u.C.F){if(!o&&u.tt())w.add(t,f);if(e==h-1){u.Z(6);if(u.C.U&&!u.C.F){c.add(t);continue t}}i.push({label:f,w:u,st:l})}}}if(!i.length)break;s=i}}if(!c.size){c=new Set(s.T().filter(nt(o)))}let p=[...w.ft()].filter(t=>c.has(t));if(p.length==c.size)p=[];return[[...c],p]}function Y(t){return{ht:t.o.key(),x:t.o.x,y:t.o.y,n:[]}}function Z(t){return function(e){return t.h(e)}}function tt(t,e){return Math.abs(t.x-e.x)+Math.abs(t.y-e.y)}function et(t,e){return function(i,l){return(t[at(i,e)]||255)-(t[at(l,e)]||255)}}function it(t,e){return function(i,l){let s=(t[at(l,e)]||255)-(t[at(i,e)]||255);if(s)return s;let r=i.y-l.y;if(r)return r;return i.x-l.x}}function lt(t,e){return function(i,l){let s=(t[at(l,e)]||255)-(t[at(i,e)]||255);if(s)return s;let r=i.y-l.y;if(r)return r;return i.x-l.x}}function st(t){return function(e,i){return tt(e.o,t)-tt(i.o,t)}}function rt(t){return function(e,i){return tt(i.o,t)-tt(e.o,t)}}function ft(t,e){let i=tt(t,e);return function(l){let s=t.step(l);return tt(s,e)<i}}function nt(t){return function(e){return!t.has(e)}}function ht(t){return function(e){return(t.get(e.o.key())||0)<5}}function ut(t){for(let e=2;e*e<=t;e++){if(t%e===0)return false}return true}function ot(t,e){let i=0;if(e[0].x==1||e[0].x==38)i-=5;if(e[0].y==1||e[0].y==20)i-=5;for(let l=1;l<e.length;l++){let s=t[at(e[l],e[l-1])]||255;if(s>18)i--;if(s>17)i--;if(s>16)i--;if(s>15)i--;if(s>14)i--}return i}class ct{constructor(){this.map={}}add(t,e){let i=p(t.x,t.y)+(p(e.x,e.y)<<16);let l=this.map[i];if(!l)l=1;else l++;this.map[i]=l}ut(t,e){let i=p(t.x,t.y)+1e9;let l=this.map[i];if(!l)l=H(0,e);else l=H(0,l+e);this.map[i]=l}get(t,e){let i=p(e.x,e.y)<<16;let l=p(t.x,t.y)+i;let s=i+1e9;return(this.map[l]||0)+(this.map[s]||0)}}function at(t,e){return t.x+t.y*40+(e.x+e.y*40)*880}function wt(t,e){let i=new Uint8Array(774400);for(let l=1;l<t.length-2;l++){let s=t[l];for(let r=1;r<s.length-1;r++){let f=s[r];if(f==="*"||f==="A"){let s=r+l*40;let f=[s];let n=new Uint8Array(880);n[s]=1;for(let l=0;l<e;l++){let e=[];for(let r of f){let f=r%40;let h=Math.floor(r/40)-1;let u=t[h][f];if(u!=="O"&&u!=="+"&&u!=="#"){let t=f+h*40;if(!n[t]){if(u==="*")i[s+t*880]=l+1;e.push(t);n[t]=1}}h+=2;u=t[h][f];if(u!=="O"&&u!=="+"&&u!=="#"){let t=f+h*40;if(!n[t]){if(u==="*")i[s+t*880]=l+1;e.push(t);n[t]=1}}h--;f--;u=t[h][f];if(u!=="O"&&u!=="+"&&u!=="#"){let t=f+h*40;if(!n[t]){if(u==="*")i[s+t*880]=l+1;e.push(t);n[t]=1}}f+=2;u=t[h][f];if(u!=="O"&&u!=="+"&&u!=="#"){let t=f+h*40;if(!n[t]){if(u==="*")i[s+t*880]=l+1;e.push(t);n[t]=1}}}if(!e.length)break;f=e}}}}return i}exports.play=function*(s){let f=new U(s);let n;let h=true;let u=3;let c;let a=new Set;let w=new Set;let d=new ct;let p=new Map;while(true){let b=Date.now();if(!h){let t=f.$();while(true){f.control(n);f.update();let e=false;if(f.I.length){for(let t of f.I){let i=s[t.o.y][t.o.x];if(!o(i)||t.k()!==i){e=true;break}}}else{t:for(let t=0;t<s.length-1;t++){let i=s[t];for(let l=0;l<i.length;l++){let s=q(f.cells[t][l]);if(s=="!")s="*";if(i[l]!=s){e=true;break t}}}}if(!e)break;t.control();t.update();f=t.$()}}h=false;let y=f.C.o;if(c&&y.h(c))p.clear();let O=[];for(let t=0;t<s.length-1;t++){let e=s[t];for(let i=0;i<e.length;i++){if(e[i]=="*"){let e=f.cells[t][i];if(!e){yield" ";continue}if(e.B===undefined)O.push(e)}}}O=O.filter(ht(p));O.sort(st(y));let A=f.I;A.sort(st(new _(20,11)));let g;let x=[];if(A.length&&(f.G>600||!O.length)){if(a.size>=A.length)a.clear();for(let t of A){if(a.has(t.name))continue;let e=t.o.x;if(e<4)e=4;else if(e>35)e=35;if(t.o.y>3)g=new _(e,t.o.y);else g=new _(e,t.o.y+1);if(g.h(y))continue;let i=tt(y,g);let l=G(s,y,g,22+40,z,d);if(!l.length)continue;x=[l[0]];let r=`${y.x},${y.y}-${t.name}-${t.o.x},${t.o.y}-${t.dir}-${l[0]}`;if(!w.has(r)){w.add(r);break}a.add(t.name)}}if(O.length&&(!A.length||f.G<=600)){let t=255;if(f.K)t=f.L-1;let e=wt(s,19);let i=O.map(Y);i.unshift(Y(f.C));for(let l=0;l<i.length;l++){let s=i[l];for(let r=l+1;r<i.length;r++){let f=i[r];let n=e[at(s,f)]||255;let h=l===0?t:19;if(n<=h){s.n.push(f);if(l>0)f.n.push(s)}}}let l=i.shift();for(let t of i)t.n.sort(lt(e,t));l.n.sort(et(e,y));if(c){let t=l.n.findIndex(Z(c));if(t>0){let e=l.n.splice(t,1)[0];l.n.unshift(e)}}let r=[];t:for(let e=0;e<C(l.n.length,10);e++){let i=l.n[e];if(t<255){let e=G(s,y,i,t,E);if(!e.length)continue;let l=f.$();for(let t of e){l.control(t);l.update();if(!l.C.U)continue t}if(!l.C.o||!l.C.o.h(i))continue;l.Z(6);if(!l.W()||l.Y())continue;if(!F(f,l.C.o,19))continue}let n=[i];let h=[];let u=new Set;let o=1;if(e===0)o=5;while(n.length){let t=n[n.length-1];u.add(t.ht);h.push(t);let e=true;for(let i of t.n){if(!u.has(i.ht)){n.push(i);e=false}}if(e){o--;if(h.length>r.length)r=h.slice(0);if(!o)break;let t=h.length;let e=n.length;while(t>0&&e>0&&h[t-1].ht===n[e-1].ht){u.delete(h.pop().ht);n.pop();t--;e--}}}}if(r.length){g=new _(r[0].x,r[0].y)}if(!g&&l.n.length){for(let e of l.n){let i=new _(e.x,e.y);let l=G(s,y,i,t,E);if(l.length){g=i;break}}}if(!g&&O.length){for(let e of O){let i=G(s,y,e.o,255,E);if(i.length){t=255;g=e.o;break}}}c=g;if(g){let e=G(s,y,g,t,E);if(e.length){let t=true;if(e.length==1&&f.K&&O.length>=3){let e=false;let i=f.K+1;let l=i+O.length;for(let t=i;t<l;t++){if(ut(t)){e=true;break}}if(!e)t=false}if(t)x=[e[0]];else x=[undefined]}}}let[m,$]=W(f,s,b,u);if(x.length&&!m.includes(x[0])){if(f.frame%7===0)x=[undefined];d.add(y,y.step(x[0]));if(g){let t=g.key();p.set(t,(p.get(t)||0)+1)}}let M=null;if($.length){$=[t,e,l,undefined,i].filter(k($));M=$[0]}else if(x.length){let t=x.filter(k(m));if(t.length){x=t}else if(g){let t=m.filter(ft(y,g));if(t.length)x=t;else x=m}else{x=m}M=x[V(x.length)]}if(M===null){M=m[V(m.length)]}n=M;yield r[M]}};
